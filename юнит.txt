import unittest
import math
from geometry_lib import (
    Circle, Triangle, Rectangle, GeometricShape,
    calculate_area, create_circle, create_triangle, create_rectangle
)


class TestCircle(unittest.TestCase):
    """Тесты для класса Circle."""
    
    def test_circle_creation_valid(self):
        """Тест создания круга с валидным радиусом."""
        circle = Circle(5.0)
        self.assertEqual(circle.radius, 5.0)
    
    def test_circle_creation_invalid_radius(self):
        """Тест создания круга с невалидным радиусом."""
        with self.assertRaises(ValueError):
            Circle(0)
        with self.assertRaises(ValueError):
            Circle(-5)
    
    def test_circle_area_calculation(self):
        """Тест вычисления площади круга."""
        circle = Circle(5.0)
        expected_area = math.pi * 25
        self.assertAlmostEqual(circle.area(), expected_area, places=10)
    
    def test_circle_area_unit_radius(self):
        """Тест площади круга с единичным радиусом."""
        circle = Circle(1.0)
        self.assertAlmostEqual(circle.area(), math.pi, places=10)
    
    def test_circle_validation(self):
        """Тест валидации круга."""
        circle = Circle(3.0)
        self.assertTrue(circle.validate())


class TestTriangle(unittest.TestCase):
    """Тесты для класса Triangle."""
    
    def test_triangle_creation_valid(self):
        """Тест создания треугольника с валидными сторонами."""
        triangle = Triangle(3.0, 4.0, 5.0)
        self.assertEqual(triangle.a, 3.0)
        self.assertEqual(triangle.b, 4.0)
        self.assertEqual(triangle.c, 5.0)
    
    def test_triangle_creation_invalid_sides(self):
        """Тест создания треугольника с невалидными сторонами."""
        # Отрицательные стороны
        with self.assertRaises(ValueError):
            Triangle(-1, 2, 3)
        
        # Нулевая сторона
        with self.assertRaises(ValueError):
            Triangle(0, 2, 3)
        
        # Нарушение неравенства треугольника
        with self.assertRaises(ValueError):
            Triangle(1, 2, 5)
    
    def test_triangle_area_calculation(self):
        """Тест вычисления площади треугольника."""
        triangle = Triangle(3.0, 4.0, 5.0)
        expected_area = 6.0  # Прямоугольный треугольник 3-4-5
        self.assertAlmostEqual(triangle.area(), expected_area, places=10)
    
    def test_triangle_area_equilateral(self):
        """Тест площади равностороннего треугольника."""
        triangle = Triangle(2.0, 2.0, 2.0)
        expected_area = math.sqrt(3)  # Площадь равностороннего треугольника со стороной 2
        self.assertAlmostEqual(triangle.area(), expected_area, places=10)
    
    def test_triangle_validation(self):
        """Тест валидации треугольника."""
        triangle = Triangle(3.0, 4.0, 5.0)
        self.assertTrue(triangle.validate())
    
    def test_right_triangle_detection(self):
        """Тест определения прямоугольного треугольника."""
        # Прямоугольный треугольник 3-4-5
        right_triangle = Triangle(3.0, 4.0, 5.0)
        self.assertTrue(right_triangle.is_right_triangle())
        
        # Прямоугольный треугольник 5-12-13
        right_triangle2 = Triangle(5.0, 12.0, 13.0)
        self.assertTrue(right_triangle2.is_right_triangle())
        
        # Не прямоугольный треугольник
        non_right_triangle = Triangle(2.0, 3.0, 4.0)
        self.assertFalse(non_right_triangle.is_right_triangle())
    
    def test_right_triangle_different_order(self):
        """Тест определения прямоугольного треугольника при разном порядке сторон."""
        # Гипотенуза не обязательно должна быть последней
        triangle1 = Triangle(5.0, 3.0, 4.0)
        triangle2 = Triangle(4.0, 5.0, 3.0)
        triangle3 = Triangle(3.0, 4.0, 5.0)
        
        self.assertTrue(triangle1.is_right_triangle())
        self.assertTrue(triangle2.is_right_triangle())
        self.assertTrue(triangle3.is_right_triangle())


class TestRectangle(unittest.TestCase):
    """Тесты для класса Rectangle."""
    
    def test_rectangle_creation_valid(self):
        """Тест создания прямоугольника с валидными размерами."""
        rectangle = Rectangle(4.0, 6.0)
        self.assertEqual(rectangle.width, 4.0)
        self.assertEqual(rectangle.height, 6.0)
    
    def test_rectangle_creation_invalid(self):
        """Тест создания прямоугольника с невалидными размерами."""
        with self.assertRaises(ValueError):
            Rectangle(0, 5)
        with self.assertRaises(ValueError):
            Rectangle(-3, 5)
        with self.assertRaises(ValueError):
            Rectangle(3, -5)
    
    def test_rectangle_area_calculation(self):
        """Тест вычисления площади прямоугольника."""
        rectangle = Rectangle(4.0, 6.0)
        self.assertEqual(rectangle.area(), 24.0)
    
    def test_rectangle_square_case(self):
        """Тест квадрата как частного случая прямоугольника."""
        square = Rectangle(5.0, 5.0)
        self.assertEqual(square.area(), 25.0)
    
    def test_rectangle_validation(self):
        """Тест валидации прямоугольника."""
        rectangle = Rectangle(3.0, 4.0)
        self.assertTrue(rectangle.validate())


class TestCalculateArea(unittest.TestCase):
    """Тесты для функции calculate_area."""
    
    def test_calculate_area_circle(self):
        """Тест вычисления площади круга через общую функцию."""
        circle = Circle(3.0)
        area = calculate_area(circle)
        expected_area = math.pi * 9
        self.assertAlmostEqual(area, expected_area, places=10)
    
    def test_calculate_area_triangle(self):
        """Тест вычисления площади треугольника через общую функцию."""
        triangle = Triangle(3.0, 4.0, 5.0)
        area = calculate_area(triangle)
        self.assertAlmostEqual(area, 6.0, places=10)
    
    def test_calculate_area_rectangle(self):
        """Тест вычисления площади прямоугольника через общую функцию."""
        rectangle = Rectangle(4.0, 5.0)
        area = calculate_area(rectangle)
        self.assertEqual(area, 20.0)
    
    def test_calculate_area_polymorphism(self):
        """Тест полиморфного вычисления площадей разных фигур."""
        shapes = [
            Circle(2.0),
            Triangle(3.0, 4.0, 5.0),
            Rectangle(3.0, 4.0)
        ]
        
        areas = [calculate_area(shape) for shape in shapes]
        
        expected_areas = [
            math.pi * 4,  # Circle
            6.0,          # Triangle
            12.0          # Rectangle
        ]
        
        for actual, expected in zip(areas, expected_areas):
            self.assertAlmostEqual(actual, expected, places=10)


class TestFactoryFunctions(unittest.TestCase):
    """Тесты для функций-фабрик."""
    
    def test_create_circle(self):
        """Тест функции создания круга."""
        circle = create_circle(5.0)
        self.assertIsInstance(circle, Circle)
        self.assertEqual(circle.radius, 5.0)
    
    def test_create_triangle(self):
        """Тест функции создания треугольника."""
        triangle = create_triangle(3.0, 4.0, 5.0)
        self.assertIsInstance(triangle, Triangle)
        self.assertEqual(triangle.a, 3.0)
        self.assertEqual(triangle.b, 4.0)
        self.assertEqual(triangle.c, 5.0)
    
    def test_create_rectangle(self):
        """Тест функции создания прямоугольника."""
        rectangle = create_rectangle(4.0, 6.0)
        self.assertIsInstance(rectangle, Rectangle)
        self.assertEqual(rectangle.width, 4.0)
        self.assertEqual(rectangle.height, 6.0)


class TestEdgeCases(unittest.TestCase):
    """Тесты граничных случаев."""
    
    def test_very_small_numbers(self):
        """Тест работы с очень маленькими числами."""
        circle = Circle(1e-10)
        self.assertGreater(circle.area(), 0)
        self.assertTrue(circle.validate())
    
    def test_very_large_numbers(self):
        """Тест работы с очень большими числами."""
        circle = Circle(1e10)
        self.assertGreater(circle.area(), 0)
        self.assertTrue(circle.validate())
    
    def test_floating_point_precision(self):
        """Тест точности вычислений с плавающей точкой."""
        # Треугольник, который должен быть прямоугольным с учетом погрешности
        triangle = Triangle(3.0000001, 4.0000001, 5.0000001)
        # Не должен быть определен как прямоугольный из-за погрешности
        self.assertFalse(triangle.is_right_triangle(tolerance=1e-10))
        # Но должен быть определен с более мягким допуском
        self.assertTrue(triangle.is_right_triangle(tolerance=1e-5))


if __name__ == '__main__':
    # Запуск всех тестов
    unittest.main(verbosity=2)